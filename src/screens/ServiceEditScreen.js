/* eslint-disable react/prop-types */
// eslint-disable-next-line no-unused-vars
import React, { useEffect, useState } from 'react';
import { useDispatch, useSelector } from 'react-redux';
import Axios from 'axios';
import { detailsService, updateService } from '../actions/serviceActions';
import LoadingBox from '../components/LoadingBox';
import MessageBox from '../components/MessageBox';
import { SERVICE_UPDATE_RESET } from '../constants/serviceConstants';

export default function ServiceEditScreen(props) {
	const serviceId = props.match.params.id;
	const [name, setName] = useState('');
	const [price, setPrice] = useState('');
	const [image, setImage] = useState('');
	const [category, setCategory] = useState('');
	const [countInStock, setCountInStock] = useState('');
	const [brand, setBrand] = useState('');
	const [description, setDescription] = useState('');

	const serviceDetails = useSelector(state => state.serviceDetails);
	const { loading, error, service } = serviceDetails;

	const serviceUpdate = useSelector(state => state.serviceUpdate);
	const {
		loading: loadingUpdate,
		error: errorUpdate,
		success: successUpdate,
	} = serviceUpdate;

	const dispatch = useDispatch();
	useEffect(() => {
		if (successUpdate) {
			props.history.push('/servicelist');
		}
		if (!service || service._id !== serviceId || successUpdate) {
			dispatch({ type: SERVICE_UPDATE_RESET });
			dispatch(detailsService(serviceId));
		} else {
			setName(service.name);
			setPrice(service.price);
			setImage(service.image);
			setCategory(service.category);
			setCountInStock(service.countInStock);
			setBrand(service.brand);
			setDescription(service.description);
		}
	}, [service, dispatch, serviceId, successUpdate, props.history]);
	const submitHandler = e => {
		e.preventDefault();
		// TODO: dispatch update service
		dispatch(
			updateService({
				_id: serviceId,
				name,
				price,
				image,
				category,
				brand,
				countInStock,
				description,
			})
		);
	};
	const [loadingUpload, setLoadingUpload] = useState(false);
	const [errorUpload, setErrorUpload] = useState('');

	const userSignin = useSelector(state => state.userSignin);
	const { userInfo } = userSignin;

	const uploadFileHandler = async e => {
		const file = e.target.files[0];
		const bodyFormData = new FormData();
		bodyFormData.append('image', file);
		setLoadingUpload(true);
		try {
			const { data } = await Axios.post('/api/uploads', bodyFormData, {
				headers: {
					'Content-Type': 'multipart/form-data',
					Authorization: `Bearer ${userInfo.token}`,
				},
			});
			setImage(data);
			setLoadingUpload(false);
		} catch (error) {
			setErrorUpload(error.message);
			setLoadingUpload(false);
		}
	};
	console.log('este es el serivicio', service);
	return (
		<div>
			<form className='form' onSubmit={submitHandler}>
				<div>
					<h1>Editar Servicio {serviceId}</h1>
				</div>
				{loadingUpdate && <LoadingBox></LoadingBox>}
				{errorUpdate && <MessageBox variant='danger'>{errorUpdate}</MessageBox>}
				{loading ? (
					<LoadingBox></LoadingBox>
				) : error ? (
					<MessageBox variant='danger'>{error}</MessageBox>
				) : (
					<>
						<div>
							<label htmlFor='name'>Nombre</label>
							<input
								id='name'
								type='text'
								placeholder='Enter name'
								value={name}
								onChange={e => setName(e.target.value)}
							></input>
						</div>
						<div>
							<label htmlFor='price'>Precio</label>
							<input
								id='price'
								type='text'
								placeholder='Enter price'
								value={price}
								onChange={e => setPrice(e.target.value)}
							></input>
						</div>
						<div>
							<label htmlFor='image'>Imagen</label>
							<input
								id='image'
								type='text'
								placeholder='Enter image'
								value={image}
								onChange={e => setImage(e.target.value)}
							></input>
						</div>
						<div>
							<label htmlFor='imageFile'>Archivo de Imagen</label>
							<input
								type='file'
								id='imageFile'
								label='Choose Image'
								onChange={uploadFileHandler}
							></input>
							{loadingUpload && <LoadingBox></LoadingBox>}
							{errorUpload && (
								<MessageBox variant='danger'>{errorUpload}</MessageBox>
							)}
						</div>
						<div>
							<label htmlFor='category'>Categoria</label>
							<input
								id='category'
								type='text'
								placeholder='Enter category'
								value={category}
								onChange={e => setCategory(e.target.value)}
							></input>
						</div>
						<div>
							<label htmlFor='brand'>Marca</label>
							<input
								id='brand'
								type='text'
								placeholder='Enter brand'
								value={brand}
								onChange={e => setBrand(e.target.value)}
							></input>
						</div>
						<div>
							<label htmlFor='countInStock'>Cantidad Existencias</label>
							<input
								id='countInStock'
								type='text'
								placeholder='Enter countInStock'
								value={countInStock}
								onChange={e => setCountInStock(e.target.value)}
							></input>
						</div>
						<div>
							<label htmlFor='description'>descripci√≥n</label>
							<textarea
								id='description'
								rows='3'
								type='text'
								placeholder='Enter description'
								value={description}
								onChange={e => setDescription(e.target.value)}
							></textarea>
						</div>
						<div>
							<label></label>
							<button className='primary' type='submit'>
								Actualizar
							</button>
						</div>
					</>
				)}
			</form>
		</div>
	);
}
